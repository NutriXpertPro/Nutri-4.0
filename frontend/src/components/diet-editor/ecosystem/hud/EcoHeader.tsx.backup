"use client"

import React from 'react'
import {
    Calculator,
    Flame,
    Activity,
    ChevronDown,
    ChevronLeft,
    Target,
    Dna,
    FileText,
    Smartphone,
    Search,
    Users,
    Utensils,
    Save,
    Loader2
} from 'lucide-react'
import { motion } from 'framer-motion'
import { useRouter } from 'next/navigation'
import Link from 'next/link'
import {
    useDietEditorStore,
    useDietEditorPatient,
    useDietEditorStore as useStore,
    useDietEditorMeals,
    CalculationMethod,
    DietType,
    ACTIVITY_LEVELS,
    DIET_TYPE_MACROS
} from '@/stores/diet-editor-store'
import { NavigationCommandPalette } from './NavigationCommandPalette'
import { HubNavigation } from './HubNavigation'
import { PDFPreviewModal } from '../../pdf/PDFPreviewModal'
import { useToast } from '@/components/ui/use-toast'
import patientService from '@/services/patient-service'
import {
    DropdownMenu,
    DropdownMenuContent,
    DropdownMenuItem,
    DropdownMenuTrigger,
    DropdownMenuLabel,
    DropdownMenuSeparator
} from '@/components/ui/dropdown-menu'
import { Input } from "@/components/ui/input"
import { Avatar, AvatarFallback, AvatarImage } from "@/components/ui/avatar"
import { Badge } from "@/components/ui/badge"
import { Button } from "@/components/ui/button"
import { Card } from "@/components/ui/card"
import { cn } from "@/lib/utils"

export function EcoHeader() {
    const router = useRouter()
    const patient = useDietEditorPatient()
    const meals = useDietEditorMeals()

    // Name Abbreviation Logic
    const formatPatientName = (name: string) => {
        if (!name) return 'Novo Paciente'
        const parts = name.trim().split(/\s+/)
        if (parts.length <= 2) return name
        const first = parts[0]
        const last = parts[parts.length - 1]
        const middles = parts.slice(1, -1).map(p => p[0].toUpperCase() + '.')
        return `${first} ${middles.join(' ')} ${last}`
    }

    // Patient Search State
    const [searchQuery, setSearchQuery] = React.useState("")
    const [searchResults, setSearchResults] = React.useState<any[]>([])
    const [isSearching, setIsSearching] = React.useState(false)

    React.useEffect(() => {
        if (searchQuery.length < 2) {
            setSearchResults([])
            return
        }
        const timer = setTimeout(async () => {
            setIsSearching(true)
            try {
                const results = await patientService.search(searchQuery)
                setSearchResults(results)
            } catch (err) {
                console.error("Error searching patients:", err)
            } finally {
                setIsSearching(false)
            }
        }, 300)
        return () => clearTimeout(timer)
    }, [searchQuery])

    // PDF Preview Modal State
    const [showPDFModal, setShowPDFModal] = React.useState(false)
    const { toast } = useToast()

    const handleGeneratePDF = () => {
        setShowPDFModal(true)
    }

    const handleSendApp = () => {
        toast({
            title: "Enviando para o App...",
            description: "Sincronizando dieta com o aplicativo do paciente.",
        })

        // Simulate API delay
        setTimeout(() => {
            toast({
                title: "Sucesso!",
                description: "Dieta enviada para o App do paciente.",
                className: "bg-green-500 text-white border-green-600"
            })
        }, 1500)
    }
    const {
        setPatient,
        calculationMethod,
        setCalculationMethod,
        activityLevel,
        setActivityLevel,
        dietType,
        setDietType,
        tmb,
        get,
        targetCalories,
        targetMacros,
        goalAdjustment,
        setGoalAdjustment,
        activeTab,
        workspaceMeals,
        saveDiet,
        isSaving
    } = useDietEditorStore()

    const handleSave = async () => {
        try {
            await saveDiet()
            toast({
                title: "Dieta Salva",
                description: "O plano alimentar foi salvo com sucesso.",
                className: "bg-green-500 text-white border-green-600"
            })
        } catch (error) {
            toast({
                title: "Erro ao salvar",
                description: "Não foi possível salvar a dieta. Verifique os dados.",
                variant: "destructive"
            })
        }
    }

    // Real-time Calculations
    const currentTotals = React.useMemo(() => {
        // If we are in the Workspace tab (diet), use workspaceMeals
        if (!activeTab || activeTab === 'diet') {
            return workspaceMeals.reduce((acc, meal) => {
                meal.foods.forEach(food => {
                    const qty = typeof food.qty === 'number' ? food.qty : 0
                    const ratio = qty / 100
                    acc.calories += (food.ptn * 4 + food.cho * 4 + food.fat * 9) * ratio
                    acc.protein += food.ptn * ratio
                    acc.carbs += food.cho * ratio
                    acc.fats += food.fat * ratio
                    acc.fiber += (food.fib || 0) * ratio
                })
                return acc
            }, { calories: 0, protein: 0, carbs: 0, fats: 0, fiber: 0 })
        }

        // Otherwise use the standard plan meals (weekPlan)
        return meals.reduce((acc, meal) => {
            meal.items.forEach(item => {
                acc.calories += item.calories
                acc.protein += item.protein
                acc.carbs += item.carbs
                acc.fats += item.fats
                acc.fiber += (item as any).fiber || 0
            })
            return acc
        }, { calories: 0, protein: 0, carbs: 0, fats: 0, fiber: 0 })
    }, [activeTab, workspaceMeals, meals])

    const weight = patient?.weight || 70

    // Helper for macro display data
    const getMacroData = (current: number, target: number, label: string) => {
        const perKg = (current / weight).toFixed(1)
        const diff = Math.round(target - current)
        const progress = Math.min((current / (target || 1)) * 100, 100)
        let statusColor = "bg-primary"
        if (progress > 110) statusColor = "bg-red-500"
        else if (progress >= 90) statusColor = "bg-green-500"
        else statusColor = "bg-amber-500"
        return { current, target, perKg, diff, progress, statusColor, label }
    }

    const proteinData = getMacroData(currentTotals.protein, targetMacros.protein, "PTN")
    const carbsData = getMacroData(currentTotals.carbs, targetMacros.carbs, "CHO")
    const fatsData = getMacroData(currentTotals.fats, targetMacros.fats, "FAT")
    const fiberData = getMacroData(currentTotals.fiber || 0, targetMacros.fiber || 25, "FIB")

    return (
        <>
            <div className="relative mb-4 bg-background z-40 shadow-sm border-b border-border/10 pb-8">
                {/* Background Banner */}
                <div className="h-20 w-full bg-linear-to-r from-primary/20 via-primary/10 to-transparent relative overflow-hidden">
                    <div className="absolute inset-0 bg-[url('/grid.svg')] opacity-10" />
                    <Link
                        href="/diets"
                        className="absolute top-6 left-4 p-2 rounded-full bg-background text-foreground hover:bg-background hover:text-foreground transition-all backdrop-blur-sm z-10 border border-border opacity-80 hover:opacity-100"
                    >
                        <ChevronLeft className="h-5 w-5" />
                    </Link>
                </div>

                {/* HEADER CONTENT FLOW */}
                <div className="px-10 flex items-center justify-between -mt-8 relative z-10">
                    {/* Patient Name and Goal - Left Side */}
                    <div className="flex items-center gap-6">
                        {/* Photo + Change Button */}
                        <div className="relative">
                            <Avatar className="h-28 w-28 border-4 border-background shadow-2xl">
                                <AvatarImage src={patient?.avatar} className="object-cover" />
                                <AvatarFallback className="text-3xl bg-primary/10 text-primary">
                                    {patient?.name?.substring(0, 2).toUpperCase() || <Users className="h-10 w-10 opacity-50" />}
                                </AvatarFallback>
                            </Avatar>

                            {/* Absolutely positioned button beneath the photo */}
                            <div className="absolute -bottom-6 left-0 right-0 flex justify-center">
                                <DropdownMenu>
                                    <DropdownMenuTrigger asChild>
                                        <button className="text-[10px] uppercase tracking-widest text-muted-foreground hover:text-primary transition-colors flex items-center gap-1 bg-background/50 backdrop-blur-sm px-2 py-0.5 rounded-full border border-border/20 shadow-xs">
                                            Trocar <ChevronDown className="h-3 w-3" />
                                        </button>
                                    </DropdownMenuTrigger>
                                    <DropdownMenuContent align="center" className="w-[300px]">
                                        <DropdownMenuLabel className="px-4 py-3">Selecionar Paciente</DropdownMenuLabel>
                                        <div className="px-3 py-2">
                                            <div className="relative">
                                                <Search className="absolute left-3 top-2.5 h-4 w-4 text-muted-foreground" />
                                                <Input
                                                    placeholder="Buscar por nome..."
                                                    className="h-10 pl-10 text-sm bg-muted/50"
                                                    value={searchQuery}
                                                    onChange={(e) => setSearchQuery(e.target.value)}
                                                />
                                            </div>
                                        </div>
                                        <DropdownMenuSeparator />
                                        {isSearching && <div className="px-4 py-3 text-xs text-muted-foreground text-center italic">Buscando...</div>}
                                        {searchResults.map(p => (
                                            <DropdownMenuItem
                                                key={p.id}
                                                onClick={() => {
                                                    // Set basic patient immediately for UI responsiveness
                                                    setPatient({
                                                        id: p.id,
                                                        name: p.name,
                                                        avatar: p.avatar,
                                                        status: true,
                                                        gender: 'M',
                                                        goal: '',
                                                        restrictions: [],
                                                        allergies: []
                                                    } as any);

                                                    // Update URL to trigger full data fetch
                                                    router.push(`/diets/create?patientId=${p.id}`);
                                                    setSearchQuery("");
                                                    setSearchResults([]);
                                                }}
                                                className="flex items-center gap-3 py-3 px-4 focus:bg-primary/10 cursor-pointer"
                                            >
                                                <Avatar className="h-8 w-8 border border-border/50">
                                                    <AvatarImage src={p.avatar} className="object-cover" />
                                                    <AvatarFallback className="text-[10px] bg-primary/5 text-primary">{p.name.substring(0, 2).toUpperCase()}</AvatarFallback>
                                                </Avatar>
                                                <div className="flex flex-col">
                                                    <span className="text-sm font-medium leading-none">{p.name}</span>
                                                    <span className="text-[10px] text-muted-foreground mt-1 uppercase tracking-tighter">ID: {p.id}</span>
                                                </div>
                                            </DropdownMenuItem>
                                        ))}
                                    </DropdownMenuContent>
                                </DropdownMenu>
                            </div>
                        </div>

                        <div className="space-y-1">
                            <div className="flex items-center gap-3">
                                <h1 className="text-3xl font-normal tracking-tight">{formatPatientName(patient?.name || '')}</h1>
                                <Badge variant="outline" className="bg-emerald-500/10 text-emerald-500 border-emerald-500/20">Ativo</Badge>
                            </div>
                            <p className="text-muted-foreground flex items-center gap-2">
                                <Target className="h-4 w-4 text-primary" />
                                <span className="uppercase tracking-widest text-xs font-normal">{patient?.goal || 'Objetivo não definido'}</span>
                            </p>
                        </div>
                    </div>

                    {/* Circular Macro Chart & Calories - Absoluto ao Centro */}
                    <div className="absolute left-[54%] -translate-x-1/2 -top-4 flex items-center gap-6">
                        <div className="scale-90 lg:scale-100">
                            <CircularMacroChart
                                totals={currentTotals}
                                targets={targetMacros}
                                targetCalories={targetCalories}
                                hideText
                            />
                        </div>
                        <div className="flex flex-col">
                            <span className="text-[10px] text-muted-foreground uppercase tracking-[0.2em] opacity-60 font-bold">Total Calórico</span>
                            <div className="flex items-baseline gap-2">
                                <span className="text-2xl lg:text-3xl font-bold text-foreground tabular-nums leading-none">
                                    {Math.round(currentTotals.calories)}
                                </span>
                                <span className="text-xs lg:text-sm text-muted-foreground opacity-40 font-medium">/ {targetCalories + (goalAdjustment || 0)}</span>
                            </div>
                            {/* Dual Caloric Adjustment Inputs */}
                            <div className="flex items-center gap-3 mt-3">
                                {/* Negative Adjustment */}
                                <div className="relative group">
                                    <span className="absolute left-0 top-1/2 -translate-y-1/2 text-xs font-bold text-red-500 group-hover:text-red-600 transition-colors">-</span>
                                    <input
                                        type="number"
                                        className="w-10 h-6 bg-transparent border-b border-border/30 text-xs text-center focus:outline-none focus:border-red-500 tabular-nums pl-2 text-red-500 placeholder:text-red-500 font-bold"
                                        placeholder="0"
                                        min="0"
                                        value={goalAdjustment < 0 ? Math.abs(goalAdjustment) : ''}
                                        onChange={(e) => {
                                            const val = Number(e.target.value);
                                            setGoalAdjustment(val > 0 ? -val : 0);
                                        }}
                                    />
                                </div>

                                <div className="flex flex-col items-center">
                                    <span className="text-[8px] text-muted-foreground uppercase opacity-50 font-bold tracking-wider">Ajuste</span>
                                    <span className="text-[8px] text-muted-foreground opacity-30">kcal</span>
                                </div>

                                {/* Positive Adjustment */}
                                <div className="relative group">
                                    <span className="absolute left-0 top-1/2 -translate-y-1/2 text-xs font-bold text-green-500 group-hover:text-green-600 transition-colors">+</span>
                                    <input
                                        type="number"
                                        className="w-10 h-6 bg-transparent border-b border-border/30 text-xs text-center focus:outline-none focus:border-green-500 tabular-nums pl-2 text-green-500 placeholder:text-green-500 font-bold"
                                        placeholder="0"
                                        min="0"
                                        value={goalAdjustment > 0 ? goalAdjustment : ''}
                                        onChange={(e) => {
                                            const val = Number(e.target.value);
                                            setGoalAdjustment(val > 0 ? val : 0);
                                        }}
                                    />
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* SELECTORS & ACTIONS - Vertical stack Right Aligned */}
                    <div className="flex flex-col items-end gap-3">
                        <div className="flex items-center gap-2 translate-y-[20px]">
                            <Selector
                                icon={Utensils}
                                label={
                                    (
                                        {
                                            'harris_benedict_1919': 'H. Benedict 1919',
                                            'harris_benedict_1984': 'H. Benedict 1984',
                                            'mifflin_1990': 'Mifflin-St Jeor',
                                            'katch_mcardle_1996': 'Katch-McArdle',
                                            'cunningham_1980': 'Cunningham',
                                            'fao_who_2004': 'FAO/WHO',
                                            'eer_iom_2005': 'EER/IOM 2005',
                                            'eer_iom_2023': 'EER/IOM 2023',
                                            'henry_rees_1991': 'Henry & Rees',
                                            'tinsley_2018_weight': 'Tinsley (Peso)',
                                            'tinsley_2018_lbm': 'Tinsley (MM)'
                                        } as Record<string, string>
                                    )[calculationMethod] || calculationMethod || 'Mifflin-St Jeor 1990'
                                }
                            >
                                {[
                                    { value: 'mifflin_1990', label: 'Mifflin-St Jeor 1990', desc: 'Padrão-ouro atual.' },
                                    { value: 'katch_mcardle_1996', label: 'Katch-McArdle 1996', desc: 'Foco em Massa Magra.' },
                                    { value: 'harris_benedict_1984', label: 'Harris-Benedict 1984', desc: 'Equação revisada.' },
                                    { value: 'harris_benedict_1919', label: 'Harris-Benedict 1919', desc: 'Equação original.' },
                                    { value: 'cunningham_1980', label: 'Cunningham 1980', desc: 'Atletas e Massa Magra.' },
                                    { value: 'fao_who_2004', label: 'FAO/WHO 2004', desc: 'Diretrizes mundiais.' },
                                    { value: 'eer_iom_2005', label: 'EER/IOM 2005', desc: 'Equações de predição.' },
                                    { value: 'eer_iom_2023', label: 'EER/IOM 2023', desc: 'Atualização recente.' },
                                    { value: 'henry_rees_1991', label: 'Henry & Rees 1991', desc: 'Populações específicas.' },
                                    { value: 'tinsley_2018_weight', label: 'Tinsley 2018 (Peso)', desc: 'Treinamento de força.' },
                                    { value: 'tinsley_2018_lbm', label: 'Tinsley 2018 (MM)', desc: 'Treinamento de força.' },
                                ].map((option) => (
                                    <DropdownMenuItem key={option.value} onClick={() => setCalculationMethod(option.value as any)} className="flex flex-col items-start py-1 px-3 cursor-pointer focus:bg-primary/10">
                                        <span className="text-xs font-medium">{option.label}</span>
                                        <span className="text-[9px] text-muted-foreground leading-tight">{option.desc}</span>
                                    </DropdownMenuItem>
                                ))}
                            </Selector>
                            <Selector
                                icon={Dna}
                                label={dietType === 'personalizada' ? 'PERSONALIZADA' : (DIET_TYPE_MACROS[dietType]?.label || 'ESTRATÉGIA').toUpperCase()}
                            >
                                {Object.keys(DIET_TYPE_MACROS).map((key) => {
                                    const data = DIET_TYPE_MACROS[key as DietType];
                                    return (
                                        <DropdownMenuItem key={key} onClick={() => setDietType(key as DietType)} className="flex flex-col items-start py-1 px-3 cursor-pointer focus:bg-primary/10">
                                            <div className="flex items-center justify-between w-full">
                                                <span className="text-xs font-medium">{data.label}</span>
                                                <Badge variant="outline" className="text-[9px] opacity-60 ml-2">{data.carbs}/{data.protein}/{data.fats}%</Badge>
                                            </div>
                                        </DropdownMenuItem>
                                    )
                                })}
                                <DropdownMenuItem onClick={() => setDietType('personalizada')} className="flex flex-col items-start py-1 px-3 cursor-pointer focus:bg-primary/10">
                                    <span className="text-xs font-medium">Personalizada</span>
                                </DropdownMenuItem>
                            </Selector>
                        </div>
                        <div className="flex gap-2 translate-y-[44px]">
                            <Button
                                size="sm"
                                onClick={handleSave}
                                disabled={isSaving}
                                className="h-[36px] px-4 gap-2 rounded-xl text-[10px] uppercase tracking-widest shadow-lg shadow-primary/20"
                            >
                                {isSaving ? <Loader2 className="h-3.5 w-3.5 animate-spin" /> : <Save className="h-3.5 w-3.5" />}
                                {isSaving ? "SALVANDO..." : "SALVAR DIETA"}
                            </Button>
                            <Button
                                variant="outline"
                                size="sm"
                                onClick={handleGeneratePDF}
                                className="h-[36px] px-4 gap-2 rounded-xl text-[10px] uppercase tracking-widest text-muted-foreground border-border/50 bg-background/50 hover:bg-background hover:text-primary transition-all"
                            >
                                <FileText className="h-3.5 w-3.5 text-amber-500" /> ENVIAR PDF
                            </Button>
                            <Button
                                variant="outline"
                                size="sm"
                                onClick={handleSendApp}
                                className="h-[36px] px-4 gap-2 rounded-xl text-[10px] uppercase tracking-widest text-muted-foreground border-border/50 bg-background/50 hover:bg-background hover:text-primary transition-all"
                            >
                                <Smartphone className="h-3.5 w-3.5 text-emerald-500" /> ENVIAR APP
                            </Button>
                        </div>
                    </div>
                </div>
            </div>

            {/* PDF Modal */}
            <PDFPreviewModal open={showPDFModal} onOpenChange={setShowPDFModal} />

            <Card variant="glass" className="w-full max-w-[1600px] mx-auto py-5 px-4 md:px-6 flex flex-col lg:flex-row items-center gap-6 md:gap-8 shadow-xl">
                <div className="flex flex-wrap items-center justify-between md:justify-center gap-6 md:gap-10 w-full lg:w-auto px-0 md:px-4 lg:border-r border-border/20">
                    <MetricBox label="TMB" value={Math.round(tmb)} unit="kcal" icon={Activity} iconColor="text-emerald-500" />
                    <MetricBox label="GCD" value={Math.round(get)} unit="kcal" icon={Flame} iconColor="text-red-500" />
                    <MetricBox label="META" value={targetCalories} unit="kcal" icon={Target} highlight />
                </div>
                <div className="lg:border-r border-border/20 px-4">
                    <DropdownMenu>
                        <DropdownMenuTrigger asChild>
                            <button className="flex flex-col items-start gap-1 p-2.5 rounded-xl hover:bg-primary/5 transition-all group border border-transparent hover:border-primary/20">
                                <span className="text-[10px] uppercase tracking-widest text-muted-foreground opacity-60">Nível de Atividade</span>
                                <div className="flex items-center gap-2 mt-0.5">
                                    <Activity className="h-5 w-5 text-emerald-500 group-hover:scale-110 transition-transform" />
                                    <span className="text-base text-foreground font-medium">
                                        {ACTIVITY_LEVELS.find(l => l.value === activityLevel)?.label || activityLevel}
                                        <span className="text-muted-foreground text-xs ml-1 font-normal">({activityLevel})</span>
                                    </span>
                                    <ChevronDown className="h-3.5 w-3.5 opacity-30" />
                                </div>
                            </button>
                        </DropdownMenuTrigger>
                        <DropdownMenuContent className="p-1">
                            {ACTIVITY_LEVELS.map(level => (
                                <DropdownMenuItem key={level.value} onClick={() => setActivityLevel(level.value)} className="py-2.5 px-4 cursor-pointer focus:bg-primary/10 flex justify-between">
                                    <span>{level.label}</span>
                                    <span className="text-muted-foreground text-xs ml-2 opacity-50">{level.value}</span>
                                </DropdownMenuItem>
                            ))}
                        </DropdownMenuContent>
                    </DropdownMenu>
                </div>
                <div className="flex-1 w-full grid grid-cols-2 sm:grid-cols-4 gap-6 px-2">
                    <MacroMonitor data={proteinData} color="bg-emerald-500" textColor="text-emerald-500" />
                    <MacroMonitor data={carbsData} color="bg-blue-500" textColor="text-blue-500" />
                    <MacroMonitor data={fatsData} color="bg-orange-500" textColor="text-orange-500" />
                    <MacroMonitor data={fiberData} color="bg-purple-500" textColor="text-purple-500" />
                </div>
            </Card>

            <div className="absolute bottom-0 left-0 w-full z-50 flex justify-center -mb-7 translate-y-[24px]">
                <HubNavigation />
            </div>
        </>
    )
}

function MetricBox({ label, value, unit, icon: Icon, highlight, iconColor }: any) {
    return (
        <div className={cn("flex flex-col items-center min-w-20 transition-transform", highlight && "scale-110")}>
            <span className="text-[10px] uppercase tracking-widest text-muted-foreground mb-1.5 flex items-center gap-2">
                {Icon && <Icon className={cn("h-4 w-4", highlight ? "text-primary" : iconColor || "text-muted-foreground")} />}
                {label}
            </span>
            <div className="text-3xl font-bold tracking-tighter tabular-nums text-foreground">{value}</div>
            <span className="text-[10px] text-muted-foreground uppercase tracking-widest">{unit}</span>
        </div>
    )
}

function Selector({ icon: Icon, label, subLabel, children }: any) {
    return (
        <DropdownMenu>
            <DropdownMenuTrigger asChild>
                <button className="flex items-center gap-2 px-3 py-1.5 rounded-xl bg-card border border-border/50 hover:border-primary/40 transition-all group min-w-32 md:min-w-40 h-[36px] overflow-hidden">
                    <Icon className="h-3.5 w-3.5 text-primary group-hover:scale-110 transition-transform shrink-0" />
                    <div className="flex flex-col items-start min-w-0">
                        <span className="text-[9px] md:text-[10px] text-muted-foreground group-hover:text-foreground transition-colors truncate w-full uppercase tracking-tighter font-bold">{label}</span>
                        {subLabel && <span className="text-[8px] md:text-[9px] font-bold text-primary -mt-0.5 opacity-70">{subLabel}</span>}
                    </div>
                    <ChevronDown className="h-3 w-3 opacity-20 ml-auto shrink-0" />
                </button>
            </DropdownMenuTrigger>
            <DropdownMenuContent align="end" className="min-w-[170px] max-h-[300px] overflow-y-auto p-0.5 shadow-2xl border-white/10 backdrop-blur-xl">
                {children}
            </DropdownMenuContent>
        </DropdownMenu>
    )
}

function MacroMonitor({ data, color, textColor }: any) {
    return (
        <div className="flex flex-col gap-2 group">
            <div className="flex items-center justify-between">
                <span className={cn("text-[10px] tracking-widest uppercase opacity-70 group-hover:opacity-100 transition-opacity font-bold", textColor)}>{data.label}</span>
                <div className="flex items-center gap-1">
                    <span className={cn("px-1.5 py-0.5 rounded-md text-[9px] tracking-tighter font-bold", data.diff > 0 ? 'bg-red-500/10 text-red-500' : 'bg-emerald-500/10 text-emerald-500')}>
                        {data.diff > 0 ? '+' : ''}{data.diff}g
                    </span>
                </div>
            </div>
            <div className="flex items-end justify-between -mt-1">
                <div className="flex items-baseline gap-1.5">
                    <span className="text-2xl font-bold text-foreground tabular-nums leading-none">{Math.round(data.current)}</span>
                    <span className="text-[11px] text-muted-foreground tabular-nums opacity-40">/ {Math.round(data.target)}g</span>
                </div>
                <span className="text-[10px] text-muted-foreground tabular-nums opacity-60">{data.perKg}g/kg</span>
            </div>
            <div className="h-2 bg-muted/30 rounded-full overflow-hidden relative shadow-inner group-hover:bg-muted/50 transition-colors">
                <motion.div className={cn("absolute left-0 top-0 bottom-0 shadow-lg", color)} initial={{ width: 0 }} animate={{ width: `${data.progress}%` }} transition={{ type: "spring", stiffness: 100, damping: 20 }} />
            </div>
        </div>
    )
}

function CircularMacroChart({ totals, targets, targetCalories, hideText }: any) {
    const size = 130
    const strokeWidth = 12
    const center = size / 2
    const radius = (size - strokeWidth) / 2
    const circumference = 2 * Math.PI * radius
    const totalGrams = totals.protein + totals.carbs + totals.fats
    const safeTotal = totalGrams || 1
    const proteinPct = (totals.protein / safeTotal) * 100
    const carbsPct = (totals.carbs / safeTotal) * 100
    const fatsPct = (totals.fats / safeTotal) * 100
    const proteinDash = (proteinPct / 100) * circumference
    const carbsDash = (carbsPct / 100) * circumference
    const fatsDash = (fatsPct / 100) * circumference
    return (
        <div className="flex items-center gap-6">
            <div className="relative flex items-center justify-center">
                <svg width={size} height={size} className="transform -rotate-90">
                    <circle cx={center} cy={center} r={radius} className="stroke-border dark:stroke-gray-300" strokeWidth={strokeWidth} fill="none" />
                    {totals.protein > 0 && <motion.circle cx={center} cy={center} r={radius} className="stroke-emerald-500" strokeWidth={strokeWidth} strokeDasharray={`${proteinDash} ${circumference}`} strokeDashoffset={0} strokeLinecap="round" fill="none" initial={{ strokeDasharray: `0 ${circumference}` }} animate={{ strokeDasharray: `${proteinDash} ${circumference}` }} />}
                    {totals.carbs > 0 && <motion.circle cx={center} cy={center} r={radius} className="stroke-blue-500" strokeWidth={strokeWidth} strokeDasharray={`${carbsDash} ${circumference}`} strokeDashoffset={-proteinDash} strokeLinecap="round" fill="none" initial={{ strokeDasharray: `0 ${circumference}`, strokeDashoffset: 0 }} animate={{ strokeDasharray: `${carbsDash} ${circumference}`, strokeDashoffset: -proteinDash }} />}
                    {totals.fats > 0 && <motion.circle cx={center} cy={center} r={radius} className="stroke-orange-500" strokeWidth={strokeWidth} strokeDasharray={`${fatsDash} ${circumference}`} strokeDashoffset={-(proteinDash + carbsDash)} strokeLinecap="round" fill="none" initial={{ strokeDasharray: `0 ${circumference}`, strokeDashoffset: 0 }} animate={{ strokeDasharray: `${fatsDash} ${circumference}`, strokeDashoffset: -(proteinDash + carbsDash) }} />}
                </svg>
                <div className="absolute inset-0 flex items-center justify-center pointer-events-none"><Target className="h-6 w-6 text-primary opacity-20" /></div>
            </div>
            {!hideText && (
                <div className="flex flex-col min-w-[120px]">
                    <div className="space-y-0.5">
                        <p className="text-[10px] text-muted-foreground uppercase tracking-widest">Total Calórico</p>
                        <div className="flex items-baseline gap-2"><span className="text-4xl font-bold text-foreground tabular-nums leading-none">{Math.round(totals.calories)}</span><span className="text-sm text-muted-foreground opacity-50 tracking-tighter">/ {targetCalories}</span></div>
                    </div>
                </div>
            )}
        </div>
    )
}
