{% extends "base_patient.html" %}
{% load static %}

{% block title %}Dashboard de {{ patient.user.name }}{% endblock %}

{% block content %}
<div id="nutrition-command-center" class="min-h-screen bg-gradient-to-br from-blue-50 via-purple-50 to-pink-50 dark:from-gray-900 dark:via-gray-800 dark:to-gray-900 text-gray-800 dark:text-gray-200">
  
  <!-- Sticky Header -->
  <div class="sticky top-0 z-30 bg-white/80 dark:bg-gray-900/80 backdrop-blur-lg shadow-lg border-b-4 border-blue-600">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
      <div class="flex items-center justify-between mb-3">
        <div>
          <h1 class="text-3xl font-bold text-gray-800 dark:text-white">{{ patient_data.nome }}</h1>
          <div class="flex items-center flex-wrap gap-x-4 gap-y-1 text-sm text-gray-600 dark:text-gray-400 mt-1">
            <span>{{ patient_data.idade }} anos</span>
            <span class="hidden sm:inline">‚Ä¢</span>
            <span>{{ patient_data.objetivo }}</span>
            <span class="hidden sm:inline">‚Ä¢</span>
            <span class="font-semibold text-blue-600 dark:text-blue-400">{{ patient_data.consultasTotal }} consultas</span>
          </div>
        </div>
        <div class="flex gap-2">
          <button id="compare-mode-btn" class="flex items-center gap-2 px-4 py-2 rounded-lg font-semibold transition-colors bg-gray-200 text-gray-700 hover:bg-gray-300 dark:bg-gray-700 dark:text-gray-200 dark:hover:bg-gray-600">
            <i data-lucide="git-compare"></i>
            <span class="hidden sm:inline">Comparar</span>
          </button>
          <button class="flex items-center gap-2 px-4 py-2 bg-gradient-to-r from-purple-600 to-pink-600 text-white rounded-lg hover:from-purple-700 hover:to-pink-700 font-semibold">
            <i data-lucide="sparkles"></i>
            <span class="hidden sm:inline">IA Insights</span>
          </button>
        </div>
      </div>
      
      <div class="flex gap-2">
        <button data-view="dashboard" class="view-tab px-4 py-2 rounded-lg font-medium transition-colors bg-blue-600 text-white">
          Dashboard
        </button>
        <button data-view="timeline" class="view-tab px-4 py-2 rounded-lg font-medium transition-colors bg-gray-100 text-gray-600 hover:bg-gray-200 dark:bg-gray-700 dark:text-gray-300 dark:hover:bg-gray-600">
          Timeline
        </button>
      </div>
    </div>
  </div>

  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    
    <!-- Dashboard View -->
    <div id="dashboard-view">
      <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl p-6 sm:p-8 mb-8 border-2 border-gray-200 dark:border-gray-700">
        <h2 class="text-2xl font-bold text-gray-800 dark:text-white mb-6 flex items-center gap-3">
          <i data-lucide="zap" class="text-yellow-500"></i>
          Dashboard Anal√≠tico
        </h2>

        <!-- Metrics Grid -->
        <div id="metrics-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-4 mb-8">
          <!-- Metric Cards will be injected here by JS -->
        </div>

        <!-- Charts Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
          <div class="bg-gray-50 dark:bg-gray-700/50 rounded-xl p-6">
            <h3 class="text-lg font-bold text-gray-800 dark:text-white mb-4 flex items-center gap-2">
              <i data-lucide="bar-chart-3"></i> Radar Corporal
            </h3>
            <div class="h-80">
              <canvas id="radarChart"></canvas>
            </div>
          </div>
          <div class="bg-gray-50 dark:bg-gray-700/50 rounded-xl p-6">
            <h3 class="text-lg font-bold text-gray-800 dark:text-white mb-4 flex items-center gap-2">
              <i data-lucide="trending-up"></i> Evolu√ß√£o Corporal
            </h3>
            <div class="h-80">
                <canvas id="evolutionChart"></canvas>
            </div>
          </div>
        </div>

        <!-- Lab Exams History -->
        <div class="mb-8">
          <h3 class="text-lg font-bold text-gray-800 dark:text-white mb-4 flex items-center gap-2">
            <i data-lucide="file-bar-chart"></i> Hist√≥rico de Exames
          </h3>
          <div id="lab-exams-history" class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <!-- Lab Exams will be injected here by JS -->
          </div>
        </div>

        <!-- Diets History -->
        <div>
          <h3 class="text-lg font-bold text-gray-800 dark:text-white mb-4 flex items-center gap-2">
            <i data-lucide="utensils"></i> Hist√≥rico de Dietas
          </h3>
          <div id="diet-history" class="space-y-3">
            <!-- Diets will be injected here by JS -->
          </div>
        </div>
      </div>
    </div>

    <!-- Timeline View -->
    <div id="timeline-view" class="hidden">
      <div class="relative">
        <div class="absolute left-4 sm:left-8 top-0 bottom-0 w-1 bg-gradient-to-b from-blue-600 via-purple-600 to-pink-600 rounded-full" style="margin-left: 0.375rem;"></div>
        <div id="consultations-timeline" class="space-y-6 relative">
          <!-- Consultation Cards will be injected here by JS -->
        </div>
      </div>
      <div id="compare-footer" class="hidden fixed bottom-8 right-8 bg-blue-600 text-white px-6 py-3 rounded-full shadow-2xl font-bold cursor-pointer hover:bg-blue-700 transition-colors animate-bounce">
        Comparar Consultas Selecionadas ‚Üí
      </div>
    </div>
  </div>
</div>

<!-- Templates for JS -->
<template id="metric-card-template">
  <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-4 sm:p-6 border-2 border-gray-100 dark:border-gray-700 hover:shadow-2xl transition-all duration-300 hover:scale-105">
    <div class="flex items-center justify-between mb-4">
      <div class="flex items-center gap-2">
        <i class="metric-icon w-5 h-5 text-blue-600 dark:text-blue-400"></i>
        <span class="metric-label text-sm font-medium text-gray-600 dark:text-gray-300"></span>
      </div>
      <i class="trend-icon w-6 h-6"></i>
    </div>
    <div class="flex items-end justify-between mb-3">
      <div>
        <div class="metric-atual text-3xl font-bold text-gray-800 dark:text-white"></div>
        <div class="text-xs text-gray-500 dark:text-gray-400">atual</div>
      </div>
      <div class="metric-mudanca text-2xl font-bold"></div>
      <div class="text-right">
        <div class="metric-inicial text-lg text-gray-600 dark:text-gray-300"></div>
        <div class="text-xs text-gray-500 dark:text-gray-400">inicial</div>
      </div>
    </div>
    <div class="w-full bg-gray-200 dark:bg-gray-600 rounded-full h-2">
      <div class="progress-bar h-2 rounded-full"></div>
    </div>
    <div class="metric-objetivo-container text-xs text-gray-500 dark:text-gray-400 mt-2 text-center" style="display: none;">
      Meta: <span class="metric-objetivo"></span>
    </div>
  </div>
</template>

<template id="consultation-card-template">
    <div class="ml-10 sm:ml-16">
        <div class="consultation-card bg-white dark:bg-gray-800 rounded-xl shadow-md border-2 border-gray-200 dark:border-gray-700 mb-4 overflow-hidden transition-all duration-300">
            <div class="p-5 cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700/50 consultation-header">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-4">
                        <div class="compare-checkbox-wrapper" style="display: none;">
                            <input type="checkbox" class="compare-checkbox w-5 h-5 rounded text-blue-600 focus:ring-blue-500">
                        </div>
                        <div class="timeline-dot w-4 h-4 rounded-full bg-blue-500"></div>
                        <div>
                            <div class="flex items-center gap-2">
                                <i data-lucide="calendar" class="w-4 h-4 text-gray-500 dark:text-gray-400"></i>
                                <span class="consultation-data font-bold text-gray-800 dark:text-white"></span>
                                <span class="consultation-first-badge text-xs bg-purple-100 text-purple-700 dark:bg-purple-900 dark:text-purple-300 px-2 py-1 rounded-full font-semibold" style="display: none;">
                                    üé¨ IN√çCIO DA JORNADA
                                </span>
                            </div>
                            <div class="consultation-dias-atras text-sm text-gray-500 dark:text-gray-400"></div>
                        </div>
                    </div>
                    <div class="flex items-center gap-4">
                        <div class="text-right">
                            <div class="consultation-peso text-lg font-bold text-gray-800 dark:text-white"></div>
                            <div class="consultation-gordura text-sm text-gray-500 dark:text-gray-400"></div>
                        </div>
                        <i class="toggle-icon w-5 h-5" data-lucide="chevron-down"></i>
                    </div>
                </div>
            </div>
            <div class="consultation-details border-t border-gray-200 dark:border-gray-700 p-5 bg-gray-50 dark:bg-gray-700/50" style="display: none;">
                <!-- Details will be injected here -->
            </div>
        </div>
    </div>
</template>

{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://unpkg.com/lucide@latest"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // --- DATA FROM DJANGO ---
    const patientData = JSON.parse('{{ patient_data_json|escapejs }}');
    const currentMetrics = JSON.parse('{{ current_metrics_json|escapejs }}');
    const radarData = JSON.parse('{{ radar_data_json|escapejs }}');
    const evolutionData = JSON.parse('{{ evolution_data_json|escapejs }}');
    const labExamsHistory = JSON.parse('{{ lab_exams_history_json|escapejs }}');
    const dietHistory = JSON.parse('{{ diet_history_json|escapejs }}');
    const consultations = JSON.parse('{{ consultations_json|escapejs }}');

    // --- STATE ---
    let activeView = 'dashboard';
    let compareMode = false;
    let selectedCompare = [];
    let expandedConsultation = null;

    // --- RENDER FUNCTIONS ---
    const renderMetricCards = () => {
        const container = document.getElementById('metrics-grid');
        const template = document.getElementById('metric-card-template');
        container.innerHTML = ''; // Clear existing
        
        const metrics = [
            { id: 'peso', label: 'Peso', icon: 'scale' },
            { id: 'gordura', label: 'Gordura', icon: 'trending-down' },
            { id: 'musculo', label: 'M√∫sculo', icon: 'trending-up' },
            { id: 'imc', label: 'IMC', icon: 'target' },
            { id: 'abdomen', label: 'Abd√¥men', icon: 'activity' }
        ];

        metrics.forEach(metricInfo => {
            const data = currentMetrics[metricInfo.id];
            if (!data) return;

            const card = template.content.cloneNode(true);
            const trendIconEl = card.querySelector('.trend-icon');
            const mudancaEl = card.querySelector('.metric-mudanca');

            let colorClass = 'text-gray-600 dark:text-gray-400';
            if (data.trend === 'down' && (metricInfo.id === 'peso' || metricInfo.id === 'gordura' || metricInfo.id === 'imc' || metricInfo.id === 'abdomen')) {
                colorClass = 'text-green-600 dark:text-green-400';
            } else if (data.trend === 'up' && metricInfo.id === 'musculo') {
                colorClass = 'text-green-600 dark:text-green-400';
            } else if (data.trend === 'up') {
                colorClass = 'text-red-600 dark:text-red-400';
            }
            
            card.querySelector('.metric-icon').setAttribute('data-lucide', metricInfo.icon);
            card.querySelector('.metric-label').textContent = metricInfo.label;
            card.querySelector('.metric-atual').textContent = data.atual;
            card.querySelector('.metric-inicial').textContent = data.inicial;
            
            mudancaEl.textContent = `${data.mudanca > 0 ? '+' : ''}${data.mudanca}`;
            mudancaEl.className += ` ${colorClass}`;
            trendIconEl.setAttribute('data-lucide', data.trend === 'down' ? 'trending-down' : data.trend === 'up' ? 'trending-up' : 'minus');
            trendIconEl.className += ` ${colorClass}`;

            const progressBar = card.querySelector('.progress-bar');
            const progressPercentage = Math.min(100, Math.abs((data.mudanca / (data.inicial || 1)) * 100));
            progressBar.style.width = `${progressPercentage}%`;
            progressBar.classList.add(data.trend === 'down' ? 'bg-green-500' : 'bg-blue-500');

            if (data.objetivo) {
                card.querySelector('.metric-objetivo-container').style.display = 'block';
                card.querySelector('.metric-objetivo').textContent = `${data.objetivo}kg`;
            }

            container.appendChild(card);
        });
    };

    const renderConsultations = () => {
        const container = document.getElementById('consultations-timeline');
        const template = document.getElementById('consultation-card-template');
        container.innerHTML = '';

        consultations.forEach(consultation => {
            const cardClone = template.content.cloneNode(true);
            const card = cardClone.querySelector('.consultation-card');
            const header = cardClone.querySelector('.consultation-header');
            const details = cardClone.querySelector('.consultation-details');
            const toggleIcon = cardClone.querySelector('.toggle-icon');

            cardClone.querySelector('.consultation-data').textContent = consultation.data;
            cardClone.querySelector('.consultation-dias-atras').textContent = `${consultation.diasAtras} dias atr√°s ‚Ä¢ Consulta #${consultation.id}`;
            cardClone.querySelector('.consultation-peso').textContent = `${consultation.peso}kg`;
            cardClone.querySelector('.consultation-gordura').textContent = `${consultation.gordura}% gordura`;

            if (consultation.isFirst) {
                card.classList.add('border-purple-400', 'dark:border-purple-600');
                cardClone.querySelector('.timeline-dot').classList.replace('bg-blue-500', 'bg-purple-500');
                cardClone.querySelector('.consultation-first-badge').style.display = 'inline-block';
            }

            // Details
            details.innerHTML = `
                <div class="grid grid-cols-2 sm:grid-cols-4 gap-4 mb-4">
                    <div class="text-center p-3 bg-white dark:bg-gray-800 rounded-lg">
                        <div class="text-xs text-gray-500 dark:text-gray-400 mb-1">M√∫sculo</div>
                        <div class="text-lg font-bold text-green-600 dark:text-green-400">${consultation.musculo}kg</div>
                    </div>
                    <div class="text-center p-3 bg-white dark:bg-gray-800 rounded-lg">
                        <div class="text-xs text-gray-500 dark:text-gray-400 mb-1">IMC</div>
                        <div class="text-lg font-bold text-blue-600 dark:text-blue-400">${consultation.imc}</div>
                    </div>
                    <div class="text-center p-3 bg-white dark:bg-gray-800 rounded-lg">
                        <div class="text-xs text-gray-500 dark:text-gray-400 mb-1">Cintura</div>
                        <div class="text-lg font-bold text-purple-600 dark:text-purple-400">${consultation.medidas.cintura}cm</div>
                    </div>
                    <div class="text-center p-3 bg-white dark:bg-gray-800 rounded-lg">
                        <div class="text-xs text-gray-500 dark:text-gray-400 mb-1">Abd√¥men</div>
                        <div class="text-lg font-bold text-orange-600 dark:text-orange-400">${consultation.medidas.abdomen}cm</div>
                    </div>
                </div>
                <div class="bg-blue-50 dark:bg-blue-900/50 p-4 rounded-lg mb-4">
                    <div class="text-sm font-semibold text-blue-900 dark:text-blue-200 mb-2">Observa√ß√µes Cl√≠nicas:</div>
                    <div class="text-sm text-blue-800 dark:text-blue-300">${consultation.observacoes}</div>
                </div>
                <div class="flex gap-2 flex-wrap">
                    ${consultation.fotos ? `<button class="flex items-center gap-2 px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors"><i data-lucide="camera" class="w-4 h-4"></i> Ver Fotos</button>` : ''}
                    ${consultation.exames ? `<button class="flex items-center gap-2 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors"><i data-lucide="file-text" class="w-4 h-4"></i> Exames</button>` : ''}
                    <button class="flex items-center gap-2 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors"><i data-lucide="utensils" class="w-4 h-4"></i> ${consultation.dieta}</button>
                </div>
            `;

            // Toggle expand/collapse
            header.addEventListener('click', () => {
                expandedConsultation = expandedConsultation === consultation.id ? null : consultation.id;
                details.style.display = expandedConsultation === consultation.id ? 'block' : 'none';
                toggleIcon.setAttribute('data-lucide', expandedConsultation === consultation.id ? 'chevron-up' : 'chevron-down');
                lucide.createIcons();
            });

            // Compare mode
            const checkboxWrapper = cardClone.querySelector('.compare-checkbox-wrapper');
            const checkbox = cardClone.querySelector('.compare-checkbox');
            if (compareMode) {
                checkboxWrapper.style.display = 'block';
            }
            checkbox.addEventListener('change', (e) => {
                e.stopPropagation();
                if (checkbox.checked) {
                    if (selectedCompare.length < 2) {
                        selectedCompare.push(consultation.id);
                    } else {
                        checkbox.checked = false; // Prevent selecting more than 2
                    }
                } else {
                    selectedCompare = selectedCompare.filter(id => id !== consultation.id);
                }
                updateCompareUI();
            });

            container.appendChild(cardClone);
        });
        updateCompareUI();
    };
    
    const renderLabExams = () => {
        const container = document.getElementById('lab-exams-history');
        container.innerHTML = '';
        if (!labExamsHistory.length) {
            container.innerHTML = `<p class="text-gray-500 dark:text-gray-400 col-span-3">Nenhum exame laboratorial registrado.</p>`;
            return;
        }
        labExamsHistory.forEach(exame => {
            const indicatorsHTML = Object.entries(exame.indicadores).map(([key, value]) => `
                <div><strong>${key.charAt(0).toUpperCase() + key.slice(1)}:</strong> ${value}</div>
            `).join('');

            container.innerHTML += `
                <div class="bg-red-50 dark:bg-red-900/30 border border-red-200 dark:border-red-800/50 rounded-xl p-4">
                    <div class="flex items-center gap-2 mb-2">
                        <i data-lucide="file-text" class="w-4 h-4 text-red-600 dark:text-red-400"></i>
                        <span class="font-semibold text-red-800 dark:text-red-300">${exame.exame}</span>
                    </div>
                    <div class="text-sm text-gray-700 dark:text-gray-300 mb-2">
                        <i data-lucide="calendar" class="w-3 h-3 inline mr-1"></i> ${exame.data}
                    </div>
                    <div class="text-xs text-gray-600 dark:text-gray-400 space-y-1">${indicatorsHTML}</div>
                    <div class="text-xs text-blue-600 dark:text-blue-400 mt-2 italic">${exame.observacoes}</div>
                </div>
            `;
        });
    };

    const renderDietHistory = () => {
        const container = document.getElementById('diet-history');
        container.innerHTML = '';
        if (!dietHistory.length) {
            container.innerHTML = `<p class="text-gray-500 dark:text-gray-400">Nenhuma dieta registrada.</p>`;
            return;
        }
        dietHistory.forEach(dieta => {
            container.innerHTML += `
                <div class="bg-white dark:bg-gray-800 p-3 rounded-lg border-l-4 border-green-500">
                    <div class="flex justify-between items-start">
                        <div>
                            <div class="font-bold text-sm">${dieta.nome}</div>
                            <div class="text-xs text-gray-600 dark:text-gray-400">In√≠cio: ${dieta.dataInicio} ‚Ä¢ ${dieta.metodo}</div>
                            <div class="text-xs text-gray-500 dark:text-gray-500 mt-1">Dura√ß√£o: ${dieta.duracao}</div>
                        </div>
                        <div class="text-right text-xs text-gray-600 dark:text-gray-400">
                            <div>Cal: ${dieta.macros.calorias}kcal</div>
                            <div>Prot: ${dieta.macros.proteinas}g</div>
                            <div>Carbs: ${dieta.macros.carboidratos}g</div>
                            <div>Gord: ${dieta.macros.gorduras}g</div>
                        </div>
                    </div>
                    <div class="text-xs text-blue-600 dark:text-blue-400 mt-1 italic">${dieta.observacoes}</div>
                </div>
            `;
        });
    };

    // --- CHARTING ---
    const createRadarChart = () => {
        const ctx = document.getElementById('radarChart').getContext('2d');
        new Chart(ctx, {
            type: 'radar',
            data: {
                labels: radarData.map(d => d.metrica),
                datasets: [
                    {
                        label: 'Inicial',
                        data: radarData.map(d => d.inicial),
                        borderColor: '#ef4444',
                        backgroundColor: 'rgba(239, 68, 68, 0.3)',
                        borderWidth: 2
                    },
                    {
                        label: 'Atual',
                        data: radarData.map(d => d.atual),
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.5)',
                        borderWidth: 2
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    r: {
                        angleLines: { color: 'rgba(128, 128, 128, 0.2)' },
                        grid: { color: 'rgba(128, 128, 128, 0.2)' },
                        pointLabels: {
                            font: { size: 12 },
                            color: document.body.classList.contains('dark') ? '#d1d5db' : '#4b5563'
                        },
                        ticks: {
                            color: document.body.classList.contains('dark') ? '#9ca3af' : '#6b7280',
                            backdropColor: 'transparent'
                        }
                    }
                },
                plugins: {
                    legend: {
                        labels: {
                            color: document.body.classList.contains('dark') ? '#d1d5db' : '#4b5563'
                        }
                    }
                }
            }
        });
    };

    const createEvolutionChart = () => {
        const ctx = document.getElementById('evolutionChart').getContext('2d');
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: evolutionData.map(d => d.data),
                datasets: [
                    {
                        label: 'Peso (kg)',
                        data: evolutionData.map(d => d.peso),
                        borderColor: '#3b82f6',
                        backgroundColor: '#3b82f6',
                        yAxisID: 'y',
                        tension: 0.3
                    },
                    {
                        label: 'Gordura (%)',
                        data: evolutionData.map(d => d.gordura),
                        borderColor: '#f59e0b',
                        backgroundColor: '#f59e0b',
                        yAxisID: 'y1',
                        tension: 0.3
                    },
                    {
                        label: 'M√∫sculo (kg)',
                        data: evolutionData.map(d => d.musculo),
                        borderColor: '#10b981',
                        backgroundColor: '#10b981',
                        yAxisID: 'y',
                        tension: 0.3
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        grid: { color: 'rgba(128, 128, 128, 0.1)' },
                        ticks: { color: document.body.classList.contains('dark') ? '#9ca3af' : '#6b7280' }
                    },
                    y: {
                        type: 'linear',
                        display: true,
                        position: 'left',
                        grid: { color: 'rgba(128, 128, 128, 0.1)' },
                        ticks: { color: document.body.classList.contains('dark') ? '#9ca3af' : '#6b7280' }
                    },
                    y1: {
                        type: 'linear',
                        display: true,
                        position: 'right',
                        grid: { drawOnChartArea: false },
                        ticks: { color: document.body.classList.contains('dark') ? '#9ca3af' : '#6b7280' }
                    }
                },
                plugins: {
                    legend: {
                        labels: {
                            color: document.body.classList.contains('dark') ? '#d1d5db' : '#4b5563'
                        }
                    }
                }
            }
        });
    };

    // --- UI & EVENT HANDLERS ---
    const updateView = () => {
        document.getElementById('dashboard-view').style.display = activeView === 'dashboard' ? 'block' : 'none';
        document.getElementById('timeline-view').style.display = activeView === 'timeline' ? 'block' : 'none';
        
        document.querySelectorAll('.view-tab').forEach(tab => {
            if (tab.dataset.view === activeView) {
                tab.classList.add('bg-blue-600', 'text-white');
                tab.classList.remove('bg-gray-100', 'text-gray-600', 'dark:bg-gray-700', 'dark:text-gray-300');
            } else {
                tab.classList.remove('bg-blue-600', 'text-white');
                tab.classList.add('bg-gray-100', 'text-gray-600', 'dark:bg-gray-700', 'dark:text-gray-300');
            }
        });
    };

    const updateCompareUI = () => {
        const compareBtn = document.getElementById('compare-mode-btn');
        const compareFooter = document.getElementById('compare-footer');
        
        if (compareMode) {
            compareBtn.classList.add('bg-blue-600', 'text-white');
            compareBtn.classList.remove('bg-gray-200', 'text-gray-700');
        } else {
            compareBtn.classList.remove('bg-blue-600', 'text-white');
            compareBtn.classList.add('bg-gray-200', 'text-gray-700');
        }

        document.querySelectorAll('.consultation-card').forEach(cardEl => {
            const id = parseInt(cardEl.dataset.id);
            if (selectedCompare.includes(id)) {
                cardEl.classList.add('border-blue-500', 'dark:border-blue-400');
            } else {
                cardEl.classList.remove('border-blue-500', 'dark:border-blue-400');
            }
        });

        compareFooter.style.display = compareMode && selectedCompare.length === 2 ? 'block' : 'none';
    };

    document.querySelectorAll('.view-tab').forEach(tab => {
        tab.addEventListener('click', () => {
            activeView = tab.dataset.view;
            updateView();
        });
    });

    document.getElementById('compare-mode-btn').addEventListener('click', () => {
        compareMode = !compareMode;
        selectedCompare = [];
        renderConsultations(); // Re-render to show/hide checkboxes
        lucide.createIcons();
    });

    // --- INITIALIZATION ---
    renderMetricCards();
    renderConsultations();
    renderLabExams();
    renderDietHistory();
    createRadarChart();
    createEvolutionChart();
    lucide.createIcons();
    updateView();
});
</script>
{% endblock %}